<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<style>
    .cY{
        color: gold;
        font-size: large;
    }
    .logoXA{

        display: flex;
        flex-wrap: nowrap;
        flex-direction: column;
        justify-content: center;

    }
    .bg-image{
        /* background-image: url('https://juegalabolita.com/LoteriaMexicanaWeb/Content/img/loteria/consulta_carton_mexico.png');
        background-size: cover;
        background-position-x: right;
        background-repeat: no-repeat;
        background-origin: content-box; */
    }
</style>

<body>
    <div class="bg-danger d-flex justify-content-center align-items-center">

        <div class="bg-white p-5 text-secondary d-flex align-items-center flex-column ph">
            <div class="bgLM">
                <h2 style="text-align: center;">Sucursales La Bolita</h2>
                <div class="row">
                    <div class="col-12">
                        <div id="mapaIframe"  style="width:100%; height:450px;"></div>
                    </div>
                    <div class="col-6">
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                              <label class="input-group-text" for="estado">Estado</label>
                            </div>
                            <select class="custom-select" id="estado">
                              <option selected value="">Estado</option>
                            </select>
                        </div>    
                    </div>
                    <div class="col-6">
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                              <label class="input-group-text" for="municipio">Municipio</label>
                            </div>
                            <select class="custom-select" id="municipio">
                              <option selected value="">Municipio</option>
                            </select>
                        </div>    
                    </div>
                </div>
                <div id="oficinas">
                </div>
            </div>
        </div>
    </div>    
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const api = axios.create({
            baseURL: 'https://api.juegalabolita.com/api/location/',
            headers:{
                'accept': 'application/json;charset=utf-8',
            },
        });

        async function fillPlazaCards(plazaData){
            const plazaContainer = document.getElementById('oficinas');
            plazaContainer.innerHTML= '';

            plazaData.forEach(plaza => {
                const plazaCard = 
                `   
                    <div class="container">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card mb-3">
                                    <div class="row g-0">
                                        <div class="col-md-6">
                                            <div class="card-body text-center">
                                                <h5 class="card-title">${plaza.nombre}</h5>
                                                <p class="card-text">${plaza.estado}</p>
                                            </div>
                                        </div>
                                        <div class="col-md-3 d-flex justify-content-center align-items-center pt-3 pb-3">
                                            <div class="text-center d-flex align-items-center">
                                                <img class="img-fluid" src="https://img.icons8.com/external-vitaliy-gorbachev-lineal-color-vitaly-gorbachev/60/external-open-ecommerce-vitaliy-gorbachev-lineal-color-vitaly-gorbachev.png" alt="external-open-ecommerce-vitaliy-gorbachev-lineal-color-vitaly-gorbachev"/>
                                                <p class="card-text ml-1"><small class="text-muted">9:00am - 9:00pm</small></p>
                                            </div>
                                        </div>
                                        <div class="col-md-3 d-flex justify-content-center align-items-center bg-image pt-3 pb-3">
                                            <button class="actualizarMapa btn btn-success btn-lg" data-src="${plaza.direccion}">Ubicación</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `
                ;
                plazaContainer.insertAdjacentHTML('beforeend', plazaCard);
            });

        }

        async function plazasByMunicipioId(municipioId){
            try {
                const response   = await api.get(`GetPlazasDisponibles/${municipioId}`);
                const plazas = response. data;

                fillPlazaCards(plazas);

            } catch (error) {
                console.error('An error occurred:', error);
            }
        }
        async function fillDropdownByState(){
            try {
                const response = await api.get('GetEstados/false');
                const estados  = response.data;
                
                populateDropdown('estado', estados, 'Estado');

                const estadoDropdown = document.getElementById('estado');
                estadoDropdown.addEventListener('change', async (event) =>{
                    const selectedEstadoId = event.target.value;
                    if (selectedEstadoId) {
                        fillPlazaCards([]);

                        await municipiosByEstadoId(selectedEstadoId);
                    } else {
                        populateDropdown('municipio', [], 'municipio')
                        fillPlazaCards([]);
                        
                    }
                });

            } catch (error) {
                console.error('An error occurred:', error);
            }
        }
        async function populateDropdown(elementId, data, defaultOptionText = null){
            const dropdown = document.getElementById(elementId);
            dropdown.innerHTML = '';
            
            if(defaultOptionText != null){
                const defaultOption = new Option(defaultOptionText, '');
                dropdown.appendChild(defaultOption);
            }

            data.forEach(item => {
                const option  = new Option(item.description, item.id)
                dropdown.appendChild(option);
            });
        }

        async function municipiosByEstadoId(estadoId){
            try {
                const response   = await api.get(`GetMunicipiosDisponibles/${estadoId}`);
                const municipios = response.data;
                
                populateDropdown('municipio', municipios, 'municipio');

                const municipioDropdown = document.getElementById('municipio');
                municipioDropdown.addEventListener('change', (event) => {
                    const selectedMunicipioId = event.target.value;
                    if(selectedMunicipioId){
                        plazasByMunicipioId(selectedMunicipioId);
                    }else{
                        fillPlazaCards([]);
                    }
                });
                
            } catch (error) {
                console.error('An error occurred:', error);
            }
        }

        fillDropdownByState();
        document.addEventListener('click', function(event){
            if(event.target.classList.contains("actualizarMapa")){
                var nuevaUbicacion = event.target.getAttribute("data-src");
                var mapaIframe     = document.getElementById("mapaIframe");
                mapaIframe.src = nuevaUbicacion;
                mapaIframe.scrollIntoView({behavior: "smooth"});
            }
        });
    </script>
    <script>
    document.addEventListener("DOMContentLoaded", function(){
        
        var offices = [
            {
                nombre: "Test 1",
                latitudeOffice :  21.00617774787068,
                longitudeOffice: -89.61409405006728,
            }, //21.00617774787068, -89.61409405006728
            {
                nombre: "Test 2",
                latitudeOffice : 40.345245,
                longitudeOffice: -70.23142,
            }
        ];

        var mapOptions = {
            zoom: 15,
            center: {lat: 51.013855362777672, lng: -89.6096203509684}
        };

        var map = new google.maps.Map(document.getElementById('mapaIframe'), mapOptions);   

        if(navigator.geolocation){
            navigator.geolocation.getCurrentPosition(function(geolocationPosition){
                var coords = geolocationPosition.coords;
                var myLatLong = new google.maps.LatLng(coords.latitude, coords.longitude);

                var marker = new google.maps.Marker({
                    position: myLatLong,
                    map: map,
                    title:  'Mi ubicación actual'
                });

                map.setCenter(myLatLong);

                var directionsService  = new google.maps.DirectionsService();
                var directionsRenderer = new google.maps.DirectionsRenderer();

                var officeLocation     = new google.maps.LatLng(offices[0].latitudeOffice, offices[0].longitudeOffice); 

                var request = {
                    origin: myLatLong,
                    destination: officeLocation,
                    travelMode: 'DRIVING'
                };

                directionsRenderer.setMap(map);
                
                directionsService.route(request, function(result, status){
                    if(status == 'OK'){
                        directionsRenderer.setDirections(result);
                    }
                });
                
            }, function(err){
                console.warn(err);
            });
        } else{
            alert("No puedes obtener la ubicación");
        }
    });
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD5fohTs6f-tbPPQJhanRj0M0HgjP6ATzg"></script>
</body>

</html>