<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<style>
    .cY{
        color: gold;
        font-size: large;
    }
    .logoXA{

        display: flex;
        flex-wrap: nowrap;
        flex-direction: column;
        justify-content: center;

    }
    .bg-image{
        /* background-image: url('https://juegalabolita.com/LoteriaMexicanaWeb/Content/img/loteria/consulta_carton_mexico.png');
        background-size: cover;
        background-position-x: right;
        background-repeat: no-repeat;
        background-origin: content-box; */
    }
</style>

<body>
    <div class="bg-danger d-flex justify-content-center align-items-center">

        <div class="bg-white p-5 text-secondary d-flex align-items-center flex-column ph">
            <div class="bgLM">
                <h2 style="text-align: center;">Sucursales La Bolita</h2>
                <div class="row">
                    <div class="col-12">
                        <iframe id="mapaIframe" src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3818.356019455189!2d-99.91574849999999!3d16.8582741!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x85caf7f7ac9580cb%3A0x9cb431b5057f64ef!2sCHEDRAUI%20PIE%20DE%20LA%20CUESTA!5e0!3m2!1ses-419!2smx!4v1691093991413!5m2!1ses-419!2smx" width="100%" height="450" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                    </div>
                    <div class="col-6">
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                              <label class="input-group-text" for="estado">Estado</label>
                            </div>
                            <select class="custom-select" id="estado">
                              <option selected value="">Estado</option>
                            </select>
                        </div>    
                    </div>
                    <div class="col-6">
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                              <label class="input-group-text" for="municipio">Municipio</label>
                            </div>
                            <select class="custom-select" id="municipio">
                              <option selected value="">Municipio</option>
                            </select>
                        </div>    
                    </div>
                </div>
                <div id="oficinas">
                </div>
            </div>
        </div>
    </div>    
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const api = axios.create({
            baseURL: 'https://api.juegalabolita.com/api/location/',
            headers:{
                'accept': 'application/json;charset=utf-8',
            },
        });

        async function fillPlazaCards(plazaData){
            const plazaContainer = document.getElementById('oficinas');
            plazaContainer.innerHTML= '';

            plazaData.forEach(plaza => {
                const plazaCard = 
                `   
                    <div class="container">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card mb-3">
                                    <div class="row g-0">
                                        <div class="col-md-6">
                                            <div class="card-body text-center">
                                                <h5 class="card-title">${plaza.nombre}</h5>
                                                <p class="card-text">${plaza.estado}</p>
                                            </div>
                                        </div>
                                        <div class="col-md-3 d-flex justify-content-center align-items-center pt-3 pb-3">
                                            <div class="text-center d-flex align-items-center">
                                                <img class="img-fluid" src="https://img.icons8.com/external-vitaliy-gorbachev-lineal-color-vitaly-gorbachev/60/external-open-ecommerce-vitaliy-gorbachev-lineal-color-vitaly-gorbachev.png" alt="external-open-ecommerce-vitaliy-gorbachev-lineal-color-vitaly-gorbachev"/>
                                                <p class="card-text ml-1"><small class="text-muted">9:00am - 9:00pm</small></p>
                                            </div>
                                        </div>
                                        <div class="col-md-3 d-flex justify-content-center align-items-center bg-image pt-3 pb-3">
                                            <button class="actualizarMapa btn btn-success btn-lg" data-src="${plaza.direccion}">Ubicación</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `
                ;
                plazaContainer.insertAdjacentHTML('beforeend', plazaCard);
            });

        }

        async function plazasByMunicipioId(municipioId){
            try {
                const response   = await api.get(`GetPlazasDisponibles/${municipioId}`);
                const plazas = response. data;

                fillPlazaCards(plazas);
                //console.log(municipios);

            } catch (error) {
                console.error('An error occurred:', error);
            }
        }
        async function fillDropdownByState(){
            try {
                const response = await api.get('GetEstados/false');
                const estados  = response.data;
                
                populateDropdown('estado', estados, 'Estado');

                const estadoDropdown = document.getElementById('estado');
                estadoDropdown.addEventListener('change', async (event) =>{
                    const selectedEstadoId = event.target.value;
                    if (selectedEstadoId) {
                        fillPlazaCards([]);

                        await municipiosByEstadoId(selectedEstadoId);
                    } else {
                        populateDropdown('municipio', [], 'municipio')
                        fillPlazaCards([]);
                        
                    }
                });

            } catch (error) {
                console.error('An error occurred:', error);
            }
        }
        async function populateDropdown(elementId, data, defaultOptionText = null){
            const dropdown = document.getElementById(elementId);
            dropdown.innerHTML = '';
            
            if(defaultOptionText != null){
                const defaultOption = new Option(defaultOptionText, '');
                dropdown.appendChild(defaultOption);
            }

            data.forEach(item => {
                const option  = new Option(item.description, item.id)
                dropdown.appendChild(option);
            });
        }

        async function municipiosByEstadoId(estadoId){
            try {
                const response   = await api.get(`GetMunicipios/${estadoId}/false`);
                const municipios = response.data;
                
                populateDropdown('municipio', municipios, 'municipio');

                const municipioDropdown = document.getElementById('municipio');
                municipioDropdown.addEventListener('change', (event) => {
                    const selectedMunicipioId = event.target.value;
                    if(selectedMunicipioId){
                        // console.log(selectedMunicipioId);
                        plazasByMunicipioId(selectedMunicipioId);
                    }else{
                        fillPlazaCards([]);
                    }
                });
                
            } catch (error) {
                console.error('An error occurred:', error);
            }
        }

        fillDropdownByState();
        document.addEventListener('click', function(event){
            if(event.target.classList.contains("actualizarMapa")){
                var nuevaUbicacion = event.target.getAttribute("data-src");
                var mapaIframe     = document.getElementById("mapaIframe");
                mapaIframe.src = nuevaUbicacion;
                mapaIframe.scrollIntoView({behavior: "smooth"});
                

                console.log('Boton de ubicación clickeado');
            }
        });
    </script>
</body>

</html>